<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Events</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Arial, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .layout {
      display: flex;
      min-height: 100vh;
    }

    /* SIDEBAR */
    .sidebar {
      width: 260px;
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(10px);
      color: white;
      padding: 25px 20px;
      box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2);
    }

    .sidebar h2 {
      text-align: center;
      margin-bottom: 40px;
      font-size: 26px;
      font-weight: 600;
      letter-spacing: 1px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .sidebar a {
      display: flex;
      align-items: center;
      color: #cbd5e1;
      text-decoration: none;
      padding: 14px 16px;
      border-radius: 10px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
      font-size: 15px;
    }

    .sidebar a:hover {
      background: rgba(100, 116, 139, 0.3);
      color: white;
      transform: translateX(5px);
    }

    .sidebar .active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    /* MAIN AREA */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* TOP BAR */
    .topbar {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      padding: 20px 35px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border-bottom: 1px solid rgba(102, 126, 234, 0.1);
    }

    .topbar span {
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
    }

    .topbar button {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border: none;
      color: white;
      padding: 10px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
      width: auto;
    }

    .topbar button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    /* CONTENT AREA */
    .content {
      padding: 35px;
      flex: 1;
      overflow-y: auto;
    }

    .content > h2 {
      color: white;
      font-size: 28px;
      margin-bottom: 25px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    /* EVENT GRID */
    .event-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 25px;
    }

    /* EVENT CARD */
    .event-card {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      gap: 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .event-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18);
      border-color: rgba(102, 126, 234, 0.3);
    }

    .event-card h3 {
      color: #1e293b;
      font-size: 20px;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .event-card h3::before {
      content: 'üìÖ';
      font-size: 18px;
    }

    .event-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
      padding: 15px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }

    .event-info p {
      color: #475569;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .event-info p strong {
      color: #1e293b;
    }

    .event-card button {
      padding: 11px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
    }

    .btn-view {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
    }

    .btn-view:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-date {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
    }

    .btn-date:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
    }

    /* Date Picker Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }

    .modal-overlay.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-content h3 {
      color: #1e293b;
      font-size: 22px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-content input[type="date"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      color: #1e293b;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      font-family: 'Segoe UI', Arial, sans-serif;
    }

    .modal-content input[type="date"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
    }

    .modal-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-confirm {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
    }

    .btn-confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
    }

    .btn-cancel {
      background: #e2e8f0;
      color: #475569;
    }

    .btn-cancel:hover {
      background: #cbd5e1;
    }

    .btn-rename {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3);
    }

    .btn-rename:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(245, 158, 11, 0.4);
    }

    .btn-delete {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
    }

    .btn-delete:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(239, 68, 68, 0.4);
    }

    /* Mobile Menu Toggle */
    .menu-toggle {
      display: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      width: auto;
      box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .overlay.active {
      display: block;
    }

    /* Loading State */
    .loading {
      text-align: center;
      color: white;
      font-size: 18px;
      padding: 40px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      color: white;
      padding: 60px 20px;
    }

    .empty-state h3 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .empty-state p {
      font-size: 16px;
      opacity: 0.9;
    }

    /* RESPONSIVE */
    @media(max-width: 1024px) {
      .event-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
      }
    }

    @media(max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -260px;
        height: 100vh;
        z-index: 1000;
        transition: left 0.3s ease;
      }

      .sidebar.active {
        left: 0;
      }

      .menu-toggle {
        display: block;
      }

      .topbar {
        padding: 15px 20px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .topbar span {
        font-size: 16px;
        order: 2;
        width: 100%;
      }

      .content {
        padding: 20px 15px;
      }

      .event-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }

    @media(max-width: 480px) {
      .sidebar {
        width: 100%;
        left: -100%;
      }

      .topbar {
        padding: 12px 15px;
      }

      .content > h2 {
        font-size: 24px;
      }

      .event-card {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Overlay for mobile menu -->
  <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

  <!-- Date Picker Modal -->
  <div class="modal-overlay" id="dateModal">
    <div class="modal-content">
      <h3>üóìÔ∏è Select Event Date</h3>
      <input type="date" id="eventDateInput" />
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeDateModal()">Cancel</button>
        <button class="btn-confirm" onclick="confirmDateChange()">Confirm</button>
      </div>
    </div>
  </div>

  <div class="layout">
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <h2>Admin Panel</h2>
      <a href="dashboard.html">üìä Dashboard</a>
      <a class="active" href="events.html">üñºÔ∏è Gallery</a>
      <a href="admin-notice.html">üì¢ Notices</a>
      <a href="#">‚öôÔ∏è Settings</a>
    </div>

    <!-- MAIN -->
    <div class="main">
      <!-- TOPBAR -->
      <div class="topbar">
        <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
        <span id="welcomeText">Event Manager üì∏</span>
        <button onclick="logout()">Logout</button>
      </div>

      <!-- CONTENT -->
      <div class="content">
        <h2>All Events</h2>
        <div id="eventList" class="event-grid">
          <div class="loading">Loading events...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Protect page
    (async function () {
      const token = localStorage.getItem("token");

      if (!token) {
        location = "login.html";
        return;
      }

      // Fetch user info to display name
      try {
        const userRes = await fetch(
          "https://cyan-sheep-842659.hostingersite.com/user-info",
          {
            headers: {
              Authorization: "Bearer " + token,
            },
          }
        );
        const userData = await userRes.json();
        
        if (userData.name) {
          document.getElementById("welcomeText").textContent = `${userData.name}'s Events üì∏`;
        }
      } catch (err) {
        console.log("Could not fetch user info");
      }
    })();

    // Format date
    function formatDate(dateString) {
      if (!dateString) return 'No date set';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }

    // Load events with stats
    async function loadEvents() {
      try {
        const res = await fetch("https://cyan-sheep-842659.hostingersite.com/public-events");
        const data = await res.json();

        const box = document.getElementById("eventList");

        if (data.length === 0) {
          box.innerHTML = `
            <div class="empty-state">
              <h3>üì≠ No Events Yet</h3>
              <p>Create your first event from the Dashboard</p>
            </div>
          `;
          return;
        }

        box.innerHTML = "";

        for (let eventData of data) {
          const eventName = eventData.event;
          const photoCount = eventData.count || 0;
          const eventDate = eventData.eventDate;

          box.innerHTML += `
            <div class="event-card">
              <h3>${eventName}</h3>
              <div class="event-info">
                <p><strong>üì∑ Photos:</strong> ${photoCount}</p>
                <p><strong>üìÖ Date:</strong> ${formatDate(eventDate)}</p>
              </div>
              <button class="btn-view" onclick="viewEvent('${eventName}')">üëÅÔ∏è View Gallery</button>
              <button class="btn-date" onclick="changeDatePrompt('${eventName}', '${eventDate || ''}')">üóìÔ∏è Change Date</button>
              <button class="btn-rename" onclick="renamePrompt('${eventName}')">‚úèÔ∏è Rename</button>
              <button class="btn-delete" onclick="deleteEvent('${eventName}')">üóëÔ∏è Delete</button>
            </div>
          `;
        }
      } catch (err) {
        console.error("Error loading events:", err);
        document.getElementById("eventList").innerHTML = `
          <div class="empty-state">
            <h3>‚ö†Ô∏è Error Loading Events</h3>
            <p>Please try again later</p>
          </div>
        `;
      }
    }

    loadEvents();

    // VIEW
    function viewEvent(ev) {
      location = `admin-gallery.html?e=${encodeURIComponent(ev)}`;
    }

    // CHANGE DATE
    let currentEventForDate = '';

    function changeDatePrompt(eventName, currentDate) {
      currentEventForDate = eventName;
      const modal = document.getElementById('dateModal');
      const dateInput = document.getElementById('eventDateInput');
      
      // Set current date or today's date
      const formattedDate = currentDate ? new Date(currentDate).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
      dateInput.value = formattedDate;
      
      modal.classList.add('active');
    }

    function closeDateModal() {
      document.getElementById('dateModal').classList.remove('active');
      currentEventForDate = '';
    }

    async function confirmDateChange() {
      const newDate = document.getElementById('eventDateInput').value;

      if (!newDate) {
        alert("‚ùå Please select a date");
        return;
      }

      const token = localStorage.getItem("token");

      try {
        const res = await fetch(
          "https://cyan-sheep-842659.hostingersite.com/update-event-date",
          {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({
              event: currentEventForDate,
              eventDate: newDate,
            }),
          }
        );

        const data = await res.json();
        alert(data.msg);
        
        if (data.msg === "Event date updated") {
          closeDateModal();
          loadEvents();
        }
      } catch (err) {
        alert("‚ùå Error updating date");
      }
    }

    // RENAME
    async function renamePrompt(oldName) {
      const newName = prompt("Enter new event name:", oldName);

      if (!newName || newName === oldName) return;

      const token = localStorage.getItem("token");

      try {
        const res = await fetch(
          "https://cyan-sheep-842659.hostingersite.com/rename-event",
          {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({
              oldEvent: oldName,
              newEvent: newName,
            }),
          }
        );

        const data = await res.json();
        alert(data.msg);
        
        if (data.msg === "Event renamed") {
          loadEvents();
        }
      } catch (err) {
        alert("‚ùå Error renaming event");
      }
    }

    // DELETE
    async function deleteEvent(ev) {
      if (!confirm(`üóëÔ∏è Are you sure you want to delete "${ev}"?\n\nThis will delete all photos in this event.`)) return;

      const token = localStorage.getItem("token");

      try {
        const res = await fetch(
          `https://cyan-sheep-842659.hostingersite.com/delete-event/${encodeURIComponent(ev)}`,
          {
            method: "DELETE",
            headers: {
              Authorization: "Bearer " + token,
            },
          }
        );

        const data = await res.json();
        alert(data.msg);
        
        if (data.msg === "Event deleted") {
          loadEvents();
        }
      } catch (err) {
        alert("‚ùå Error deleting event");
      }
    }

    // LOGOUT
    function logout() {
      localStorage.removeItem("token");
      location = "login.html";
    }

    // Toggle mobile menu
    function toggleMenu() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }
  </script>
</body>
</html>